# 自動実行機能の使い方

## ✅ 実装完了

ユーザーが登録した時間に自動的にスクレイピングが実行される機能を実装しました。

## 🔧 動作の仕組み

1. **ジョブ登録時**: 定期実行ジョブを登録すると、そのジョブのスケジュール時間（`schedule_time1`と`schedule_time2`）に基づいて、自動的にCronタスクが作成されます。

2. **アプリケーション起動時**: 開発サーバーを起動すると、データベースからすべてのアクティブなスケジュールジョブを取得し、それぞれのスケジュールに基づいてCronタスクを自動的に設定します。

3. **ジョブ更新時**: ジョブのスケジュール時間やステータス（アクティブ/非アクティブ）を変更すると、対応するCronタスクも自動的に更新されます。

4. **ジョブ削除時**: ジョブを削除すると、関連するCronタスクも自動的に削除されます。

## 🚀 使用方法

### 1. 開発サーバーを起動

```bash
cd frontend
npm run dev
```

### 2. 初回起動時の初期化

開発サーバーを起動した後、**初回のAPIアクセス時に自動的にCronスケジューラーが初期化されます**。

または、手動で初期化エンドポイントを呼び出すこともできます：

```powershell
# PowerShell
curl http://localhost:3000/api/cron/init
```

### 3. 定期実行ジョブを登録

定期実行画面（`/scheduled`）から、実行時刻を指定してジョブを登録してください。

登録すると、指定した時刻に自動的にスクレイピングが実行されます。

## 📋 動作確認

### ログで確認

開発サーバーのターミナルで、以下のようなログが表示されます：

```
動的Cronスケジューラーを初期化中...
アクティブなスケジュールジョブ: 1件
Cronタスクを作成: ジョブID=xxx, 時刻=09:15:00, Cron式=15 9 * * *
Cronタスクを作成: ジョブID=xxx, 時刻=22:15:00, Cron式=15 22 * * *
動的Cronスケジューラーを初期化しました（2個のCronタスクを作成）
```

指定した時刻になると、以下のようなログが表示されます：

```
定期実行開始: ジョブID=xxx, 時刻=09:15:00
ジョブ実行開始: ジョブ名 (ID: xxx)
ジョブ実行成功 (ジョブID=xxx): {...}
```

## ⚙️ 技術的な詳細

### 実装ファイル

- `frontend/lib/dynamic-cron-scheduler.ts`: 動的Cronスケジューラーのコア機能
- `frontend/lib/init-cron-on-startup.ts`: アプリケーション起動時の初期化処理
- `frontend/app/api/jobs/route.ts`: ジョブ作成時にCronタスクを登録
- `frontend/app/api/jobs/[id]/route.ts`: ジョブ更新・削除時にCronタスクを更新・削除
- `frontend/app/api/cron/route.ts`: 初回アクセス時にスケジューラーを初期化
- `frontend/app/api/cron/init/route.ts`: 手動初期化エンドポイント

### 動作環境

- **開発環境**: 自動実行が有効になります
- **本番環境**: 外部のCronサービス（cron-job.org等）を使用することを推奨します（自動実行は無効）

### スケジュール形式

- 時間形式: `HH:MM:SS` または `HH:MM`（例: `09:15:00` または `09:15`）
- 1つのジョブに最大2つの実行時刻を設定可能（`schedule_time1`と`schedule_time2`）

## 🔍 トラブルシューティング

### 自動実行されない場合

1. **開発サーバーが起動しているか確認**
   ```bash
   npm run dev
   ```

2. **スケジューラーが初期化されているか確認**
   ブラウザで以下のURLにアクセスして確認：
   ```
   http://localhost:3000/api/cron/init
   ```

3. **ジョブがアクティブか確認**
   ジョブの`is_active`フィールドが`true`になっている必要があります。

4. **ターミナルのログを確認**
   スケジューラーの初期化ログや実行ログが表示されているか確認してください。

### ジョブが複数回実行される場合

同じジョブに対して複数のCronタスクが作成されている可能性があります。開発サーバーを再起動してください。

## 📝 注意事項

- **開発環境専用**: この機能は開発環境でのみ動作します。本番環境では外部のCronサービスを使用してください。
- **サーバーが停止すると実行されない**: 開発サーバーを停止すると、Cronタスクも停止します。
- **時刻の設定**: システム時刻（PCの時刻）に基づいて実行されます。

