# Cronタスクの設定について（FAQ）

## ❓ Cronタスクが作成された後、何か設定する必要があるの？

**答え：基本的には追加設定は不要です。** ただし、動作確認のためのポイントを説明します。

## 🔄 Cronタスクが作成されるタイミング

### 1. ジョブ登録時（自動的に作成）

定期実行ジョブを登録すると、**その場で自動的にCronタスクが作成されます**。

```typescript
// ジョブ作成時に自動実行
await updateJobSchedule(jobId, time1, time2);
```

**この時点で、指定した時刻に自動実行される準備が整います。**

### 2. アプリケーション起動時（既存ジョブの読み込み）

開発サーバーを起動すると、データベースからすべてのアクティブなスケジュールジョブを読み込んで、Cronタスクを作成します。

## ✅ 動作確認

### 確認方法1: ターミナルのログを確認

開発サーバーのターミナルで、以下のようなログが表示されれば、Cronタスクが正常に作成されています：

```
Cronタスクを作成: ジョブID=xxx, 時刻=09:15:00, Cron式=15 9 * * *
動的Cronスケジューラーを初期化しました（1個のCronタスクを作成）
```

### 確認方法2: 初期化エンドポイントで確認（推奨）

開発サーバー起動後、以下のURLにアクセスして確実に初期化します：

```
http://localhost:3000/api/cron/init
```

または、ブラウザの開発者ツールのコンソールで：

```javascript
fetch('http://localhost:3000/api/cron/init').then(r => r.json()).then(console.log)
```

## ⚠️ 注意事項

### 1. 開発サーバーが起動している必要がある

**重要**: Cronタスクは開発サーバーのプロセス内で動作します。サーバーを停止すると、Cronタスクも停止します。

- ✅ 開発サーバーが起動している → Cronタスクが動作
- ❌ 開発サーバーが停止している → Cronタスクが動作しない

### 2. 初回起動時の初期化

開発サーバーを起動した直後は、以下のいずれかのタイミングで初期化が行われます：

- **自動初期化**: `init-cron-on-startup.ts`のモジュール読み込み時（Next.jsの動作に依存）
- **手動初期化**: `/api/cron`エンドポイントへの初回アクセス時
- **明示的な初期化**: `/api/cron/init`エンドポイントへのアクセス

**推奨**: 確実に動作させるため、初回起動時に `/api/cron/init` にアクセスすることをお勧めします。

### 3. ジョブ登録後の動作

ジョブを登録した後は、**追加の設定は不要です**。指定した時刻になると自動的に実行されます。

## 📋 動作フロー

```
1. 定期実行ジョブを登録
   ↓
2. Cronタスクが自動的に作成される（即座に）
   ↓
3. 指定した時刻になると自動実行される
   ↓
4. スクレイピングが実行される
```

## 🔍 トラブルシューティング

### Cronタスクが作成されない場合

1. **開発サーバーが起動しているか確認**
   ```bash
   npm run dev
   ```

2. **初期化エンドポイントにアクセス**
   ```
   http://localhost:3000/api/cron/init
   ```

3. **ターミナルのログを確認**
   - エラーメッセージがないか確認
   - Cronタスク作成のログが表示されているか確認

### 指定時刻に実行されない場合

1. **システム時刻を確認**
   - PCの時刻が正しいか確認
   - タイムゾーンが正しいか確認

2. **ジョブがアクティブか確認**
   - ジョブの`is_active`が`true`になっているか
   - ジョブのステータスを確認

3. **ログを確認**
   - 指定時刻に実行ログが表示されているか
   - エラーメッセージがないか

## 🎯 まとめ

**Cronタスクが作成された後は、基本的に追加設定は不要です。**

- ✅ ジョブ登録時に自動的にCronタスクが作成される
- ✅ 指定した時刻に自動実行される
- ✅ 開発サーバーが起動していれば動作する

**ただし、確実に動作させるためには：**

1. 開発サーバーが起動していることを確認
2. （推奨）初回起動時に `/api/cron/init` にアクセスして初期化
3. ターミナルのログで動作を確認

以上です！

