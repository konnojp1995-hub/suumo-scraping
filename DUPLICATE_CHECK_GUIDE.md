# 重複チェック機能の説明

## 📋 実装内容

定期実行の場合、**過去14日間で「SUUMO物件コード」が重複した場合は出力結果に含めない**機能を実装しました。

## 🔍 動作の仕組み

### 定期実行の場合

1. **対象期間**: 過去14日間
2. **対象範囲**: すべての定期実行ジョブ（特定のジョブに限定しない）
3. **チェック項目**: SUUMO物件コード（`property_code`）

### 手動実行の場合

- 重複チェックは実行されません
- すべての物件が出力結果に含まれます

## 📊 処理フロー

```
1. スクレイピングで物件情報を取得
   ↓
2. 定期実行の場合のみ重複チェックを実行
   ↓
3. 過去14日間のすべての定期実行履歴を取得
   ↓
4. 各物件のSUUMO物件コードが過去14日間の実行履歴に存在するかチェック
   ↓
5. 重複していない物件のみを出力結果に含める
   ↓
6. 重複件数と新規件数をログに出力
```

## 💡 具体例

### シナリオ1: 初回実行

- 過去14日間の実行履歴: なし
- 抽出物件数: 50件
- 重複物件数: 0件
- **出力結果: 50件すべて**

### シナリオ2: 2回目の実行（同じ物件が含まれる場合）

- 過去14日間の実行履歴: 1件（前回の実行）
- 前回の実行で抽出された物件コード: `100418644106`, `100418644107`, ...
- 今回抽出された物件コード: `100418644106`, `100418644108`, `100418644109`（`100418644106`は重複）
- 抽出物件数: 50件
- 重複物件数: 1件
- **出力結果: 49件（重複1件を除外）**

### シナリオ3: 複数のジョブが存在する場合

- ジョブA（過去7日前に実行）: 物件コード `AAA`, `BBB`, `CCC`
- ジョブB（過去3日前に実行）: 物件コード `DDD`, `EEE`, `FFF`
- ジョブC（今回実行）: 物件コード `AAA`, `GGG`, `HHH`（`AAA`はジョブAと重複）
- **出力結果**: `GGG`, `HHH`のみ（`AAA`は過去14日間の実行履歴に存在するため除外）

## 🔧 実装の詳細

### `duplicate-checker.ts`の変更点

- `daysToCheck`パラメータを追加（過去何日間をチェックするか）
- `checkAllScheduledJobs`パラメータを追加（すべての定期実行ジョブを対象にするか）
- 過去14日間の実行履歴を取得するクエリを追加

### `scrape/route.ts`の変更点

- 定期実行の場合、`filterDuplicateProperties`を呼び出す際に以下を指定：
  - `daysToCheck: 14`（過去14日間）
  - `checkAllScheduledJobs: true`（すべての定期実行ジョブを対象）

## 📝 ログ出力

重複チェック実行時、以下のようなログが出力されます：

```
重複チェックを実行中（過去14日間の定期実行を対象）...
過去14日間の定期実行履歴: 5件
重複チェック完了: 新規45件、重複5件（過去14日間の定期実行と比較）
```

## ⚠️ 注意事項

1. **SUUMO物件コードが必須**: 物件コードが取得できない物件は、重複チェックの対象外となります（すべて新規として扱われます）

2. **期間の計算**: 過去14日間は、実行時の時刻から14日前までを指します（時分秒は考慮されます）

3. **定期実行のみ対象**: 手動実行の場合、重複チェックは実行されません

4. **すべての定期実行ジョブを対象**: 特定のジョブだけでなく、すべての定期実行ジョブの過去14日間を対象とします

## 🧪 テスト方法

1. 定期実行ジョブを登録
2. 初回実行で物件情報を取得（全件が出力されることを確認）
3. 2回目実行で、同じ物件コードが含まれる場合、重複分が除外されることを確認
4. ログで重複件数と新規件数が正しく表示されることを確認

